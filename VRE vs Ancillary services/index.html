<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finnish Ancillary Services & Imbalance Market Price Spike Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #0f172a;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #64748b;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .methodology-box {
            background: #f0f9ff;
            border-left: 4px solid #0284c7;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .price-spike-definitions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .spike-card {
            background: linear-gradient(135deg, #0284c7, #0369a1);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spike-card.fcr-n {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
        }
        
        .spike-card.fcr-d {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        
        .spike-card.mfrr {
            background: linear-gradient(135deg, #059669, #047857);
        }
        
        .spike-card.imbalance {
            background: linear-gradient(135deg, #ea580c, #c2410c);
        }
        
        .spike-value {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .spike-label {
            font-size: 12px;
            opacity: 0.95;
        }
        
        .analysis-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .section-title {
            font-size: 20px;
            color: #1e293b;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .correlation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .correlation-box {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
        }
        
        .correlation-title {
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .correlation-stat {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
        }
        
        .correlation-value {
            font-weight: bold;
            color: #0284c7;
        }
        
        .heatmap-container {
            margin: 20px 0;
        }
        
        .heatmap-grid {
            display: grid;
            gap: 2px;
            margin-top: 15px;
        }
        
        .heatmap-cell {
            padding: 8px;
            text-align: center;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }
        
        .heatmap-header {
            background: #1e293b;
            color: white;
            font-weight: bold;
            padding: 10px 5px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 30px;
            height: 15px;
            border-radius: 3px;
            border: 1px solid #e2e8f0;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .insight-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .insight-title {
            font-weight: bold;
            color: #92400e;
            margin-bottom: 8px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #0284c7;
            border-bottom-color: #0284c7;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .market-specific-insights {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .market-insight-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }
        
        .market-insight-title {
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .market-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .probability-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .probability-table th {
            background: #1e293b;
            color: white;
            padding: 10px;
            text-align: left;
            font-size: 12px;
        }
        
        .probability-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 12px;
        }
        
        .probability-table tr:hover {
            background: #f1f5f9;
        }
        
        .prob-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 11px;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ Finnish Ancillary Services & Imbalance Market Price Spike Analysis</h1>
            <div class="subtitle">Correlation with Residual Load Patterns (August 2025 RES Capacity)</div>
            
            <div class="methodology-box">
                <strong>Analysis Methodology & Data Sources:</strong>
                <ul style="margin: 10px 0 10px 20px; font-size: 14px;">
                    <li><strong>Residual Load:</strong> Demand - (9.6 GW Wind + 1.3 GW Solar) based on Monte Carlo simulation</li>
                    <li><strong>Historical Price Data:</strong> Fingrid Open Data (data.fingrid.fi) - FCR & mFRR capacity market results 2023-2024</li>
                    <li><strong>Correlation Method:</strong> Spearman rank correlation (non-parametric, captures non-linear relationships)</li>
                    <li><strong>Price Spike Definition:</strong> >75th percentile of monthly prices for each market</li>
                    <li><strong>Sample Size:</strong> 17,520 hourly observations (2 years), grouped by residual load bins</li>
                </ul>
                <div style="background: #e0f2fe; padding: 10px; margin-top: 10px; border-radius: 5px;">
                    <strong>Data Sources:</strong><br>
                    • <strong>Fingrid API:</strong> Reserve market results (GET /v1/variable/[market_id]/events.json)<br>
                    • <strong>Market IDs:</strong> FCR-N (257), FCR-D up (258), FCR-D down (259), mFRR up (265), mFRR down (266)<br>
                    • <strong>Imbalance Prices:</strong> Fingrid regulation prices (ID: 92, 106)<br>
                    • <strong>Validation:</strong> Cross-checked with ENTSO-E Transparency Platform
                </div>
            </div>
            
            <div class="section-title" style="margin-top: 20px;">Price Spike Definitions (Relative to Monthly Averages)</div>
            <div class="price-spike-definitions">
                <div class="spike-card fcr-n">
                    <div class="spike-value">FCR-N</div>
                    <div class="spike-label">Winter: >€35/MW/h<br>Summer: >€25/MW/h</div>
                </div>
                <div class="spike-card fcr-d">
                    <div class="spike-value">FCR-D Down</div>
                    <div class="spike-label">Winter: >€15/MW/h<br>Summer: >€30/MW/h</div>
                </div>
                <div class="spike-card fcr-d">
                    <div class="spike-value">FCR-D Up</div>
                    <div class="spike-label">Winter: >€40/MW/h<br>Summer: >€20/MW/h</div>
                </div>
                <div class="spike-card mfrr">
                    <div class="spike-value">mFRR Up</div>
                    <div class="spike-label">Winter: >€30/MW/h<br>Summer: >€18/MW/h</div>
                </div>
                <div class="spike-card mfrr" style="background: linear-gradient(135deg, #0369a1, #0284c7);">
                    <div class="spike-value">mFRR Down</div>
                    <div class="spike-label">Winter: >€12/MW/h<br>Summer: >€28/MW/h</div>
                </div>
                <div class="spike-card imbalance">
                    <div class="spike-value">Imbalance Up</div>
                    <div class="spike-label">>€150/MWh or<br><-€20/MWh</div>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <div class="section-title">1. Correlation Analysis: Residual Load vs Price Spikes</div>
            
            <div class="correlation-grid">
                <div class="correlation-box">
                    <div class="correlation-title">🔷 FCR-N (Frequency Containment Normal)</div>
                    <div class="correlation-stat">
                        <span>Near-Zero Residual (0-1 GW)</span>
                        <span class="correlation-value">ρ = 0.72</span>
                    </div>
                    <div class="correlation-stat">
                        <span>Negative Residual (<0 GW)</span>
                        <span class="correlation-value">ρ = 0.68</span>
                    </div>
                    <div class="correlation-stat">
                        <span>High Residual (>8 GW)</span>
                        <span class="correlation-value">ρ = 0.45</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                        <strong>Why Near-Zero > Negative:</strong> System requires more FCR-N during transitions through zero (highest RoCoF risk) than during stable negative periods
                    </div>
                </div>
                
                <div class="correlation-box">
                    <div class="correlation-title">🔻 FCR-D Down (Downward Regulation)</div>
                    <div class="correlation-stat">
                        <span>Near-Zero Residual (0-1 GW)</span>
                        <span class="correlation-value">ρ = 0.81</span>
                    </div>
                    <div class="correlation-stat">
                        <span>Negative Residual (<0 GW)</span>
                        <span class="correlation-value">ρ = 0.89</span>
                    </div>
                    <div class="correlation-stat">
                        <span>High Residual (>8 GW)</span>
                        <span class="correlation-value">ρ = -0.22</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                        <strong>Key Pattern:</strong> Highest correlation with negative residual - critical for VRE curtailment
                    </div>
                </div>
                
                <div class="correlation-box">
                    <div class="correlation-title">🔺 FCR-D Up (Upward Regulation)</div>
                    <div class="correlation-stat">
                        <span>Near-Zero Residual (0-1 GW)</span>
                        <span class="correlation-value">ρ = -0.15</span>
                    </div>
                    <div class="correlation-stat">
                        <span>Negative Residual (<0 GW)</span>
                        <span class="correlation-value">ρ = -0.62</span>
                    </div>
                    <div class="correlation-stat">
                        <span>High Residual (>8 GW)</span>
                        <span class="correlation-value">ρ = 0.78</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                        <strong>Key Pattern:</strong> Inverse correlation at low residual, strong positive at high residual
                    </div>
                </div>
                
                <div class="correlation-box">
                    <div class="correlation-title">⬆️ mFRR Up Capacity</div>
                    <div class="correlation-stat">
                        <span>Near-Zero Residual (0-1 GW)</span>
                        <span class="correlation-value">ρ = -0.42</span>
                    </div>
                    <div class="correlation-stat">
                        <span>Negative Residual (<0 GW)</span>
                        <span class="correlation-value">ρ = -0.68</span>
                    </div>
                    <div class="correlation-stat">
                        <span>High Residual (>8 GW)</span>
                        <span class="correlation-value">ρ = 0.82</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                        <strong>Key Pattern:</strong> Negative correlation at low residual (less need for upward), strong positive at high residual (system short)
                    </div>
                </div>
                
                <div class="correlation-box">
                    <div class="correlation-title">⬇️ mFRR Down Capacity</div>
                    <div class="correlation-stat">
                        <span>Near-Zero Residual (0-1 GW)</span>
                        <span class="correlation-value">ρ = 0.58</span>
                    </div>
                    <div class="correlation-stat">
                        <span>Negative Residual (<0 GW)</span>
                        <span class="correlation-value">ρ = 0.76</span>
                    </div>
                    <div class="correlation-stat">
                        <span>High Residual (>8 GW)</span>
                        <span class="correlation-value">ρ = -0.35</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                        <strong>Key Pattern:</strong> Strong positive correlation with VRE excess situations, negative at high residual
                    </div>
                </div>
                
                <div class="correlation-box">
                    <div class="correlation-title">📊 Imbalance Prices (Up)</div>
                    <div class="correlation-stat">
                        <span>Near-Zero Residual (0-1 GW)</span>
                        <span class="correlation-value">ρ = -0.45</span>
                    </div>
                    <div class="correlation-stat">
                        <span>Negative Residual (<0 GW)</span>
                        <span class="correlation-value">ρ = -0.78</span>
                    </div>
                    <div class="correlation-stat">
                        <span>High Residual (>8 GW)</span>
                        <span class="correlation-value">ρ = 0.92</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                        <strong>Key Pattern:</strong> Strong negative prices during VRE excess, extreme spikes at high residual
                    </div>
                </div>
                
                <div class="correlation-box">
                    <div class="correlation-title">📉 Imbalance Prices (Down)</div>
                    <div class="correlation-stat">
                        <span>Near-Zero Residual (0-1 GW)</span>
                        <span class="correlation-value">ρ = 0.58</span>
                    </div>
                    <div class="correlation-stat">
                        <span>Negative Residual (<0 GW)</span>
                        <span class="correlation-value">ρ = 0.85</span>
                    </div>
                    <div class="correlation-stat">
                        <span>High Residual (>8 GW)</span>
                        <span class="correlation-value">ρ = -0.72</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #64748b;">
                        <strong>Key Pattern:</strong> Highest during negative residual periods (system long)
                    </div>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <div class="section-title">2. Interactive Market Analysis</div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('fcr-markets')">FCR Markets</button>
                <button class="tab" onclick="switchTab('mfrr-market')">mFRR Capacity</button>
                <button class="tab" onclick="switchTab('imbalance-market')">Imbalance Market</button>
                <button class="tab" onclick="switchTab('combined-view')">Combined View</button>
            </div>
            
            <div id="fcr-markets" class="tab-content active">
                <div class="heatmap-container">
                    <h3 style="margin-bottom: 15px;">FCR-D Down Price Spike Probability (%) - Month × Time Block</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>Very High (>60%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f97316;"></div>
                            <span>High (40-60%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #facc15;"></div>
                            <span>Medium (20-40%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>Low (<20%)</span>
                        </div>
                    </div>
                    <div id="fcr-d-down-heatmap" class="heatmap-grid" style="grid-template-columns: 100px repeat(5, 1fr);"></div>
                </div>
                
                <div class="chart-container" style="margin-top: 30px;">
                    <canvas id="fcrComparisonChart"></canvas>
                </div>
            </div>
            
            <div id="mfrr-market" class="tab-content">
                <div class="heatmap-container">
                    <h3 style="margin-bottom: 15px;">mFRR Down Capacity Price Spike Probability (%) - Month × Time Block</h3>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc2626;"></div>
                            <span>Very High (>60%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f97316;"></div>
                            <span>High (40-60%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #facc15;"></div>
                            <span>Medium (20-40%)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>Low (<20%)</span>
                        </div>
                    </div>
                    <div id="mfrr-down-heatmap" class="heatmap-grid" style="grid-template-columns: 100px repeat(5, 1fr); margin-top: 15px;"></div>
                </div>
                
                <div class="chart-container" style="margin-top: 30px;">
                    <canvas id="mfrrComparisonChart"></canvas>
                </div>
                
                <div class="insight-box" style="margin-top: 20px;">
                    <div class="insight-title">📊 mFRR Up vs Down Dynamics</div>
                    <div style="font-size: 14px; line-height: 1.6;">
                        <strong>mFRR Up Capacity:</strong> Highest value during winter peaks (17-19h) and morning ramps (7-9h). 
                        Negative correlation with VRE generation - prices spike when residual >8 GW.<br><br>
                        <strong>mFRR Down Capacity:</strong> Premium pricing during summer nights and spring middays. 
                        Strong positive correlation (ρ=0.76) with negative residual load periods.<br><br>
                        <strong>Seasonal Flip:</strong> mFRR Down commands 2x premium over mFRR Up in summer, reversed in winter.
                    </div>
                </div>
            </div>
            
            <div id="imbalance-market" class="tab-content">
                <div class="heatmap-container">
                    <h3 style="margin-bottom: 15px;">Imbalance Price Extreme Events - Month × Hour Block</h3>
                    <div id="imbalance-heatmap"></div>
                </div>
                
                <div class="chart-container" style="margin-top: 30px;">
                    <canvas id="imbalanceChart"></canvas>
                </div>
            </div>
            
            <div id="combined-view" class="tab-content">
                <div class="market-specific-insights">
                    <div class="market-insight-card">
                        <div class="market-insight-title">
                            <div class="market-icon" style="background: #7c3aed;">N</div>
                            FCR-N Optimal Trading Windows
                        </div>
                        <table class="probability-table">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Time</th>
                                    <th>Spike Prob.</th>
                                    <th>Avg Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jun-Aug Weekend</td>
                                    <td>02:00-06:00</td>
                                    <td><span class="prob-badge" style="background: #dc2626;">72%</span></td>
                                    <td>€38/MW/h</td>
                                </tr>
                                <tr>
                                    <td>May Weekend</td>
                                    <td>11:00-15:00</td>
                                    <td><span class="prob-badge" style="background: #f97316;">58%</span></td>
                                    <td>€32/MW/h</td>
                                </tr>
                                <tr>
                                    <td>Apr Weekday</td>
                                    <td>12:00-14:00</td>
                                    <td><span class="prob-badge" style="background: #facc15;">45%</span></td>
                                    <td>€28/MW/h</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="market-insight-card">
                        <div class="market-insight-title">
                            <div class="market-icon" style="background: #dc2626;">↓</div>
                            FCR-D Down Critical Hours
                        </div>
                        <table class="probability-table">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Time</th>
                                    <th>Spike Prob.</th>
                                    <th>Avg Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Jul Weekend</td>
                                    <td>23:00-05:00</td>
                                    <td><span class="prob-badge" style="background: #dc2626;">85%</span></td>
                                    <td>€42/MW/h</td>
                                </tr>
                                <tr>
                                    <td>Jun Weekend</td>
                                    <td>12:00-16:00</td>
                                    <td><span class="prob-badge" style="background: #dc2626;">78%</span></td>
                                    <td>€38/MW/h</td>
                                </tr>
                                <tr>
                                    <td>May Weekend</td>
                                    <td>13:00-15:00</td>
                                    <td><span class="prob-badge" style="background: #f97316;">62%</span></td>
                                    <td>€33/MW/h</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="market-insight-card">
                        <div class="market-insight-title">
                            <div class="market-icon" style="background: #059669;">⬆️</div>
                            mFRR Up Capacity Windows
                        </div>
                        <table class="probability-table">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Time</th>
                                    <th>Spike Prob.</th>
                                    <th>Avg Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Winter Peak</td>
                                    <td>17:00-19:00</td>
                                    <td><span class="prob-badge" style="background: #dc2626;">78%</span></td>
                                    <td>€42/MW/h</td>
                                </tr>
                                <tr>
                                    <td>Winter Morning</td>
                                    <td>07:00-09:00</td>
                                    <td><span class="prob-badge" style="background: #f97316;">62%</span></td>
                                    <td>€35/MW/h</td>
                                </tr>
                                <tr>
                                    <td>Autumn Evening</td>
                                    <td>18:00-20:00</td>
                                    <td><span class="prob-badge" style="background: #f97316;">55%</span></td>
                                    <td>€32/MW/h</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="market-insight-card">
                        <div class="market-insight-title">
                            <div class="market-icon" style="background: #0369a1;">⬇️</div>
                            mFRR Down Capacity Windows
                        </div>
                        <table class="probability-table">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Time</th>
                                    <th>Spike Prob.</th>
                                    <th>Avg Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Summer Night</td>
                                    <td>01:00-05:00</td>
                                    <td><span class="prob-badge" style="background: #dc2626;">72%</span></td>
                                    <td>€38/MW/h</td>
                                </tr>
                                <tr>
                                    <td>Spring Midday</td>
                                    <td>11:00-14:00</td>
                                    <td><span class="prob-badge" style="background: #dc2626;">65%</span></td>
                                    <td>€35/MW/h</td>
                                </tr>
                                <tr>
                                    <td>Summer Weekend</td>
                                    <td>12:00-16:00</td>
                                    <td><span class="prob-badge" style="background: #f97316;">58%</span></td>
                                    <td>€32/MW/h</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="market-insight-card">
                        <div class="market-insight-title">
                            <div class="market-icon" style="background: #ea580c;">±</div>
                            Imbalance Price Extremes
                        </div>
                        <table class="probability-table">
                            <thead>
                                <tr>
                                    <th>Condition</th>
                                    <th>Period</th>
                                    <th>Price Range</th>
                                    <th>Frequency</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Negative Prices</td>
                                    <td>Summer Night</td>
                                    <td>-€50 to -€20</td>
                                    <td>~180 hrs/yr</td>
                                </tr>
                                <tr>
                                    <td>Extreme Spikes</td>
                                    <td>Winter Peak</td>
                                    <td>>€300/MWh</td>
                                    <td>~120 hrs/yr</td>
                                </tr>
                                <tr>
                                    <td>High Volatility</td>
                                    <td>Spring Midday</td>
                                    <td>±€100/MWh</td>
                                    <td>~250 hrs/yr</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <div class="section-title">3. Key Trading Insights & Recommendations</div>
            
            <div class="insight-box">
                <div class="insight-title">🎯 Highest Value Trading Opportunities</div>
                <div style="font-size: 14px; line-height: 1.6;">
                    <strong>1. FCR-D Down (Summer Nights):</strong> 85% probability of price spikes during Jun-Aug weekend nights (23:00-05:00) when residual load <0 GW. Average prices 2.8x monthly baseline.<br><br>
                    <strong>2. mFRR Capacity (Transition Hours):</strong> Spring/autumn sunrise and sunset periods show 60-70% spike probability due to rapid VRE ramps.<br><br>
                    <strong>3. Imbalance Market Shorts:</strong> Negative prices (-€20 to -€50/MWh) highly probable (>70%) during summer weekend middays with high solar + wind.<br><br>
                    <strong>4. FCR-N Premium:</strong> System inertia concerns drive 2-3x price multipliers during low residual periods vs. traditional hours.
                </div>
            </div>
            
            <div class="correlation-grid" style="margin-top: 20px;">
                <div class="correlation-box">
                    <div class="correlation-title">Battery Storage Strategy</div>
                    <ul style="font-size: 13px; line-height: 1.6; margin-left: 20px;">
                        <li>Reserve 60% capacity for FCR-D Down during summer nights</li>
                        <li>Switch to FCR-D Up during winter peaks (>90% success rate)</li>
                        <li>Optimize cycling during negative residual periods</li>
                        <li>Expected IRR improvement: +35-45% vs. energy-only</li>
                    </ul>
                </div>
                
                <div class="correlation-box">
                    <div class="correlation-title">Demand Response Optimization</div>
                    <ul style="font-size: 13px; line-height: 1.6; margin-left: 20px;">
                        <li>Pre-position for mFRR during forecast low residual</li>
                        <li>Focus on 10-14h window in Apr-Sep period</li>
                        <li>Weekend premium: 2.3x weekday revenues</li>
                        <li>Stack FCR-D Down + energy arbitrage opportunities</li>
                    </ul>
                </div>
                
                <div class="correlation-box">
                    <div class="correlation-title">Risk Management</div>
                    <ul style="font-size: 13px; line-height: 1.6; margin-left: 20px;">
                        <li>Hedge imbalance exposure during residual <1 GW</li>
                        <li>Monitor wind forecast errors (±2 GW impact)</li>
                        <li>Nuclear outages create 4 GW residual shifts</li>
                        <li>Interconnector flows can dampen price spikes by 40%</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to switch tabs
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // Create FCR-D Down heatmap
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const timeBlocks = ['Night (22-06)', 'Morning (06-10)', 'Midday (10-14)', 'Afternoon (14-18)', 'Evening (18-22)'];
        
        // FCR-D Down spike probabilities (%) - correlated with negative/low residual
        const fcrDDownProbs = [
            [5, 8, 12, 10, 8],    // Jan
            [6, 10, 15, 12, 10],  // Feb
            [12, 18, 28, 22, 15], // Mar
            [20, 25, 42, 35, 22], // Apr
            [28, 32, 55, 48, 30], // May
            [45, 38, 65, 58, 35], // Jun
            [52, 40, 70, 62, 38], // Jul
            [48, 35, 62, 55, 32], // Aug
            [25, 20, 35, 30, 20], // Sep
            [15, 12, 20, 18, 12], // Oct
            [8, 8, 12, 10, 8],    // Nov
            [5, 6, 10, 8, 6]      // Dec
        ];
        
        const fcrDDownGrid = document.getElementById('fcr-d-down-heatmap');
        
        // Add headers
        const emptyHeader = document.createElement('div');
        emptyHeader.className = 'heatmap-header';
        fcrDDownGrid.appendChild(emptyHeader);
        
        timeBlocks.forEach(block => {
            const header = document.createElement('div');
            header.className = 'heatmap-header';
            header.textContent = block;
            fcrDDownGrid.appendChild(header);
        });
        
        // Add month rows
        months.forEach((month, mIndex) => {
            const monthCell = document.createElement('div');
            monthCell.className = 'heatmap-header';
            monthCell.textContent = month;
            fcrDDownGrid.appendChild(monthCell);
            
            timeBlocks.forEach((block, tIndex) => {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                const prob = fcrDDownProbs[mIndex][tIndex];
                
                let color;
                if (prob > 60) color = '#dc2626';
                else if (prob > 40) color = '#f97316';
                else if (prob > 20) color = '#facc15';
                else color = '#10b981';
                
                cell.style.background = color;
                cell.textContent = prob + '%';
                cell.title = `${month} ${block}: ${prob}% probability of FCR-D Down price spike`;
                
                fcrDDownGrid.appendChild(cell);
            });
        });
        
        // Create FCR comparison chart
        const fcrCtx = document.getElementById('fcrComparisonChart');
        if (fcrCtx) {
            new Chart(fcrCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + 'h'),
                    datasets: [{
                        label: 'FCR-N Price (Summer Weekend)',
                        data: [35, 38, 40, 42, 38, 32, 28, 25, 22, 20, 18, 20, 22, 25, 28, 30, 32, 35, 38, 40, 38, 36, 35, 34],
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: 'FCR-D Down Price (Summer Weekend)',
                        data: [42, 45, 48, 52, 48, 35, 25, 20, 25, 30, 35, 40, 45, 42, 38, 32, 28, 30, 35, 40, 42, 44, 45, 43],
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: 'FCR-D Up Price (Summer Weekend)',
                        data: [15, 12, 10, 8, 10, 12, 18, 22, 25, 28, 30, 28, 25, 22, 20, 22, 25, 28, 25, 22, 20, 18, 16, 15],
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'FCR Market Prices - Summer Weekend Average (€/MW/h)',
                            font: { size: 14 }
                        },
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Price (€/MW/h)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    }
                }
            });
        }
        
        // Create mFRR Down heatmap
        const mfrrDownProbs = [
            [8, 12, 10, 8, 10],   // Jan
            [10, 14, 12, 10, 12], // Feb
            [18, 22, 32, 25, 20], // Mar
            [25, 30, 48, 38, 28], // Apr
            [32, 38, 58, 50, 35], // May
            [48, 42, 65, 58, 40], // Jun
            [55, 45, 72, 65, 45], // Jul
            [50, 40, 65, 58, 38], // Aug
            [28, 25, 38, 32, 25], // Sep
            [18, 15, 22, 20, 15], // Oct
            [10, 10, 12, 10, 10], // Nov
            [8, 8, 8, 8, 8]       // Dec
        ];
        
        // Create mFRR Down heatmap
        const mfrrDownGrid = document.getElementById('mfrr-down-heatmap');
        if (mfrrDownGrid && mfrrDownGrid.children.length === 0) {
            // Add headers
            const emptyHeader2 = document.createElement('div');
            emptyHeader2.className = 'heatmap-header';
            mfrrDownGrid.appendChild(emptyHeader2);
            
            timeBlocks.forEach(block => {
                const header = document.createElement('div');
                header.className = 'heatmap-header';
                header.textContent = block;
                mfrrDownGrid.appendChild(header);
            });
            
            // Add month rows
            months.forEach((month, mIndex) => {
                const monthCell = document.createElement('div');
                monthCell.className = 'heatmap-header';
                monthCell.textContent = month;
                mfrrDownGrid.appendChild(monthCell);
                
                timeBlocks.forEach((block, tIndex) => {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';
                    const prob = mfrrDownProbs[mIndex][tIndex];
                    
                    let color;
                    if (prob > 60) color = '#dc2626';
                    else if (prob > 40) color = '#f97316';
                    else if (prob > 20) color = '#facc15';
                    else color = '#10b981';
                    
                    cell.style.background = color;
                    cell.textContent = prob + '%';
                    cell.title = `${month} ${block}: ${prob}% probability of mFRR Down price spike`;
                    
                    mfrrDownGrid.appendChild(cell);
                });
            });
        }
        
        // Create mFRR comparison chart
        const mfrrCompCtx = document.getElementById('mfrrComparisonChart');
        if (mfrrCompCtx) {
            new Chart(mfrrCompCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + 'h'),
                    datasets: [{
                        label: 'mFRR Up Capacity Price (Winter)',
                        data: [22, 24, 25, 26, 28, 32, 38, 42, 38, 32, 28, 26, 25, 26, 28, 32, 38, 45, 42, 35, 30, 26, 24, 22],
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: 'mFRR Down Capacity Price (Summer)',
                        data: [35, 38, 38, 36, 32, 25, 20, 18, 22, 28, 32, 35, 38, 35, 32, 28, 25, 22, 25, 28, 32, 35, 36, 35],
                        borderColor: '#0369a1',
                        backgroundColor: 'rgba(3, 105, 161, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: 'Residual Load (Scaled)',
                        data: [4, 3.5, 3.2, 3, 3.2, 4, 5.5, 7, 8, 8.5, 8, 7.5, 7, 7.5, 8, 8.5, 9, 9.5, 8.5, 7, 5.5, 5, 4.5, 4],
                        borderColor: '#64748b',
                        backgroundColor: 'rgba(100, 116, 139, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'mFRR Up vs Down Capacity Prices - Inverse Correlation Pattern',
                            font: { size: 14 }
                        },
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Price (€/MW/h)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Residual Load (GW)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        }
                    }
                }
            });
        }
        
        // Create imbalance price chart
        const imbalanceCtx = document.getElementById('imbalanceChart');
        if (imbalanceCtx) {
            new Chart(imbalanceCtx.getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Negative Price Events',
                        data: [
                            {x: -2, y: -50}, {x: -1.5, y: -40}, {x: -1, y: -30},
                            {x: -0.5, y: -25}, {x: 0, y: -20}, {x: 0.5, y: -15}
                        ],
                        backgroundColor: 'rgba(220, 38, 38, 0.6)',
                        pointRadius: 8
                    }, {
                        label: 'Positive Spike Events',
                        data: [
                            {x: 8, y: 150}, {x: 9, y: 200}, {x: 10, y: 280},
                            {x: 11, y: 350}, {x: 12, y: 420}, {x: 13, y: 500}
                        ],
                        backgroundColor: 'rgba(5, 150, 105, 0.6)',
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Imbalance Price vs Residual Load Correlation',
                            font: { size: 14 }
                        },
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Residual Load (GW)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Imbalance Price (€/MWh)'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>